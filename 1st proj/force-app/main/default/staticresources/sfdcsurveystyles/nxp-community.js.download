$(document).ready(function() {

    var debug = false;

    function findBootstrapEnvironment() {
        var envs = ["ExtraSmall", "Small", "Medium", "Large"];
        var envValues = ["xs", "sm", "md", "lg"];

        var $el = $('<div>');
        $el.appendTo($('body'));

        for (var i = envValues.length - 1; i >= 0; i--) {
            var envVal = envValues[i];

            $el.addClass('hidden-' + envVal);
            if ($el.is(':hidden')) {
                $el.remove();
                return envs[i]
            }
        }
    }

    if (debug) {
        $(window).resize(function() {
            console.info(findBootstrapEnvironment() + " width: " + $(window).width() + "px.");
        });
    }


    $(".imagebar img").on("click", function() {
        var elm = null;
        var boxHeight = null;
        var bState = findBootstrapEnvironment();
        var colomnSpan = (bState == "ExtraSmall" || bState == "Small") ? 1 : 3;

        if (colomnSpan == 1) elm = $(this).closest(".col-md-4").find(".img-span-" + colomnSpan);
        if (colomnSpan == 3) {
            elm = $(this).closest(".imagebar").find(".img-span-" + colomnSpan);
            var caret_position = (($(this).parent().offset().left - $(this).closest($(".imagebar")).offset().left) - 7) + ($(this).width() / 2);
            elm.find(".fa-caret-up").css("left", caret_position);
        }

        $.each($("div[state=open]"), function() {
            if (!$(this).is(elm) && colomnSpan == 1) {
                $(this).attr("state", "closed");
                $(this).animate({
                    height: 0,
                    opacity: 0
                });
            } else {

                if ($(this).is(elm) && colomnSpan == 3) {
                    $(this).attr("state", "closed");
                }
            }
        });

        var content = $(this).closest(".col-md-4").find(".img-span-1 .subnav").html();
        elm.find(".subnav").html(content);
        boxHeight = elm.find(".subnav").innerHeight() + elm.find(".fa-caret-up").innerHeight();

        var state = elm.attr("state");
        if (state == "closed" || state == undefined) {
            elm.attr("state", "open");

            elm.animate({
                height: boxHeight,
                opacity: 1
            });
        }
        if (state == "open") {
            elm.attr("state", "closed");
            elm.animate({
                height: 0,
                opacity: 0
            });
        }
    })



    $("a[data-toggle=popover]")
        .popover({
            placement: 'bottom',
            html: true,
            animation: true,
            container: $(".container:first"),
            content: $('#user-config-popover').html()
        })
        .click(function(e) {
            e.preventDefault();



            $('html').on('mousedown', function() {
                $("a[data-toggle=popover]").popover("hide");
                $(this).unbind("mousedown");
            });

        });

    jQuery.fn.exists = function(){return this.length>0;}

    $(window).resize(function() {
        if ($("a[data-toggle=popover]").exists()) {
            $("a[data-toggle=popover]").popover("hide");
        }

        if ($(".main-nav .container").exists()) {
            $(".main-nav .container").css("height", 70);
            $(".main-nav .container").attr("state", "closed");
        }        

        
    });




    $.each($(".list-faq-container div[id^=collapsed-content]"), function(index, element) {
        $('#collapsed-content' + (index + 1)).on('shown.bs.collapse', function() {
            $(this).parent().find(".fa-angle-right").removeClass("fa-angle-right").addClass("fa-angle-down");
        });

        $('#collapsed-content' + (index + 1)).on('hidden.bs.collapse', function() {
            $(this).parent().find(".fa-angle-down").removeClass("fa-angle-down").addClass("fa-angle-right");
        });
    });

    $('.collapse-trigger-open').click();


    var $star_rating = $('.star-rating .fa');

    var SetRatingStar = function() {
        return $star_rating.each(function() {
            if (parseInt($star_rating.siblings('input.rating-value').val()) >= parseInt($(this).data('rating'))) {
                return $(this).removeClass('fa-star-o').addClass('fa-star');
            } else {
                return $(this).removeClass('fa-star').addClass('fa-star-o');
            }
        });
    };

    $star_rating.on('click', function() {
        $star_rating.siblings('input.rating-value').val($(this).data('rating'));
        return SetRatingStar();
    });

    SetRatingStar();

    $('#search').on('click', function() {
        $('.search-autocomplete').css('display', 'block');
        $('.search-autocomplete').animate({
            height: 300,
            opacity: 1
        });
    });

    $(".main-nav .container button").on("click", function() {
        var elm = $(".main-nav .container");
        var boxMaxHeight = $("html").find(".main-nav .container .row").innerHeight();
        var boxMinHeight = 70;

        var state = elm.attr("state");
        if (state == "closed" || state == undefined) {
            elm.attr("state", "open");

            elm.animate({
                height: boxMaxHeight,
                //opacity: 1
            }, 500);
        }
        if (state == "open") {
            elm.attr("state", "closed");
            elm.animate({
                height: boxMinHeight,
                //opacity: 0
            });
        }

    });

})
